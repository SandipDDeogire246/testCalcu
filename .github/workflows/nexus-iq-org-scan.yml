name: Nexus IQ Bulk Scan (Manual Only)

on:
  workflow_dispatch: {}    # üî• Only runs when manually triggered

permissions:
  contents: read

jobs:
  bulk-scan:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------------------------------------
    # 1. List all repos in the organization
    # -----------------------------------------------------------
    - name: Get Organization Repos
      id: repo_list
      uses: actions/github-script@v7
      with:
        script: |
          const repos = await github.paginate(
            github.rest.repos.listForOrg,
            { org: "YOUR_ORG_NAME", per_page: 100 }
          );
          return repos.map(r => r.name);
        result-encoding: string

    # -----------------------------------------------------------
    # 2. Loop through each repo and scan
    # -----------------------------------------------------------
    - name: Scan Repos with Nexus IQ
      env:
        REPO_LIST: ${{ steps.repo_list.outputs.result }}
        NEXUS_IQ_URL: "https://nexusiq.example.com"
        NEXUS_IQ_STAGE: "Source"
        NEXUS_IQ_APP_PREFIX: "org-scan"
        NEXUS_IQ_USERNAME: ${{ secrets.NEXUS_IQ_USERNAME }}
        NEXUS_IQ_PASSWORD: ${{ secrets.NEXUS_IQ_PASSWORD }}
      run: |
        echo "$REPO_LIST" | jq -r '.[]' | while read repo; do
          
          echo "-----------------------------------------------------"
          echo "üîç Scanning Repo: $repo"
          echo "-----------------------------------------------------"

          git clone --quiet https://github.com/YOUR_ORG_NAME/$repo.git 
          cd $repo

          # Default branch detection
          BRANCH=$(git symbolic-ref --short refs/remotes/origin/HEAD | sed 's@^origin/@@')
          git checkout $BRANCH

          # Detect project type
          if [ -f pom.xml ]; then
             echo "‚û° Java project detected"
             BUILD_CMD="mvn -q -DskipTests package"
          elif [ -f package.json ]; then
             echo "‚û° Node.js project detected"
             BUILD_CMD="npm install --quiet"
          elif [ -f requirements.txt ]; then
             echo "‚û° Python project detected"
             BUILD_CMD="pip install -r requirements.txt"
          else
             echo "‚ö† Unknown type, skipping build"
             BUILD_CMD="true"
          fi

          echo "‚ñ∂ Running build..."
          eval $BUILD_CMD || echo "‚ö† Build failed ‚Äî scanning anyway"

          # Download IQ CLI
          curl -L -o iq-cli.jar "$NEXUS_IQ_URL/cli/latest/iq-cli.jar"

          # Run Nexus IQ scan (Source stage)
          java -jar iq-cli.jar \
            -i "${NEXUS_IQ_APP_PREFIX}-${repo}" \
            -s "$NEXUS_IQ_URL" \
            -a "$NEXUS_IQ_USERNAME:$NEXUS_IQ_PASSWORD" \
            -t "$NEXUS_IQ_STAGE" \
            .

          cd ..
          rm -rf $repo
        done
